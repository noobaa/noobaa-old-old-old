<!DOCTYPE html>
<html ng-app="noobaa_app" xmlns:fb="http://ogp.me/ns/fb#" lang="en">

<head>
	<?# def.include('common_head.html') ?>
</head>

<body ng-cloak ng-controller="AdminoobaaCtrl" class="bglight">
	<?# def.facebook_init_body ?>

	<div class="container">
		<table class="table">
			<thead>
				<th>#</th>
				<th>Name</th>
				<th>providers</th>
				<th>Alpha</th>
				<th>Files</th>
				<th>Quota</th>
				<th>Consumption</th>
				<th>Custom Email</th>
				<th>Devices</th>
			</thead>
			<tbody>

				<tr ng-repeat="(row_index,user) in users_array | orderBy:'_id':true ">
					<td>{{users_array.length-row_index}}</td>
					<td>{{ user.name}}</td>
					<td>
						<div ng-show="user.fb"> FB </div>
						<div ng-show="user.google"> Google </div></td>
					<td>
						<button 
						ng-class="{true: ' btn btn-success', false:'btn btn-warning'}[!!user.alpha_tester]"
							ng-click="toggle_alpha(user)">
							{{user.alpha_tester || 'false'}}
						</button>
					</td>
					<td>{{user.files}}</td>
					<td>{{human_size(user.consumption)}}</td>
					<td>{{human_size(user.quota)}}</td>
					<td>{{user.email}}</td>
					<td>
						<table
							class="table table-condensed">
							<thead>
								<th>Device</th>
								<th>Host</th>
								<th>OS</th>
								<th>Last Update</th>
								<th>#Updates</th>
								<th>CoShare</th>
							</thead>
							<tbody>
								<tr ng-repeat="(dev_id,dev) in user.devices">
									<td>{{dev.name}}</td>
									<td>{{dev.host_info.hostname}}</td>
									<td>{{dev.host_info.platform}}</td>
									<td>{{locale_date(dev.last_update)}}</td>
									<td>{{dev.total_updates}}</td>
									<td>{{human_size(dev.coshare_space)}}</td>
								</tr>
							</tbody>
						</table>
					</td>
				</tr>


			</tbody>
		</table>
	</div>

	<?# def.include('common_scripts.html') ?>

	<!-- server data is safely embedded in a JSON type script -->
	<script id="users_data" type="application/json">
		<?= JSON.stringify(it.users) ?>
	</script>

	<script type="text/javascript">
		
		AdminoobaaCtrl.$inject = ['$scope', '$http', '$window', '$timeout'];
		
		function AdminoobaaCtrl($scope, $http, $window, $timeout) {
			// parse user data from safe json in html
			$scope.users = JSON.parse($('#users_data').html());
			$scope.users_array = _.values($scope.users);
			$scope.row_num=0
			console.log('USERS AND DEVICES DATA:', $scope.users);
			
			$scope.locale_date = function(date) {
				if (!date) {
					return '';
				}
				// convert using Locale to have proper timezone displayed
				date = new Date(date);
				return date.toLocaleString();
			}
			$scope.toggle_alpha = function(user) {
				var question = 'Change alpha to ' + !user.alpha_tester + ' ?';
				if (!$window.confirm(question)) {
					return;
				}
				$http({
					method: 'PUT',
					url: '/adminoobaa/',
					data: {
						updates: [{
							user_id: user._id,
							args: {
								alpha_tester: !user.alpha_tester
							}
						}]
					}
				}).success(function(data, status, headers, config) {
					console.log('[ok] toggle_alpha', data);
					$window.location.reload();
				}).error(function(data, status, headers, config) {
					console.error('[ERR] toggle_alpha failed', data, status);
					$window.alert(JSON.stringify(data));
				});
			}
		}
	</script>

</body>

</html>